# System Architecture: Supervisor-Orchestrated Fact Checker

This document details the Supervisor State Machine, the Model Context Protocol (MCP) Interface, and the Data Flow of the Fact Checker MAS implementation.

---

## 1. The Orchestration Layer (`agents/graph.py`)

The system utilizes a Supervisor-Worker pattern implemented via **LangGraph**.

### 1.1 State Schema

The memory shared between the Supervisor and Workers is defined by the following schema:

```python
class AgentState(TypedDict):
    claim: str              # User input
    queries: List[str]      # Generated by Analyzer
    evidence: List[str]     # Collected by Searcher
    verdict: str            # Final decision
    reason: str             # Justification
    tool_calls: int         # Metric tracking
    next_step: str          # Router Signal (Analyzer|Searcher|Verifier|END)
    retry_count: int        # Loop prevention
```

### 1.2 Supervisor Logic (The Router)

The Supervisor Node acts as the state machine controller. It accepts inputs (queries, evidence, and verdict) and applies the following routing logic:

**Logic Flow:**

  * **If** verdict exists $\rightarrow$ **END**
  * **If** queries are missing $\rightarrow$ **Analyzer**
  * **If** queries exist but evidence is missing $\rightarrow$ **Searcher**
  * **Condition:** If evidence is found but labeled "No Reliable Results" $\rightarrow$ **Analyzer** (Triggers retry with better keywords)
  * **If** evidence is valid $\rightarrow$ **Verifier**

---

## 2 The Communication Layer (`agents/mcp_interface.py`)

To satisfy the requirement of deploying each agent as an independent MCP Server, this project implements a custom MCP Client Bridge.

### 2.1 Process Isolation

Instead of importing Python modules directly, the Orchestrator spawns independent processes for each agent.

  * **Client:** `agents/mcp_interface.py`
  * **Transport:** `stdio_client` (Standard Input/Output Pipes)
  * **Protocol:** Model Context Protocol (MCP) JSON-RPC

**Code Pattern:**

```python
# The Orchestrator does NOT import mcp_server.agent_analyzer
# It spawns it as a subprocess:
server_params = StdioServerParameters(
    command=sys.executable,
    args=["mcp_server/agent_analyzer.py"], # Running as script
    env=None
)
```

This architecture ensures that agents are decoupled microservices. A failure in a single agent process cannot corrupt the memory or stability of the Orchestrator.

---

## 3 The Agent Microservices (`mcp_servers/`)

### 3.1 Agent: Analyzer

**Type:** FastMCP Server

  * **Time Anchoring:** Injects the current year (`datetime.now().year`) into ambiguous queries to ensure temporal relevance.
  * **Typo Correction:** Utilizes Large Language Models (LLMs) to correct entity naming errors (e.g., "Shiek" $\rightarrow$ "Sheikh").
  * **Context Injection:** Appends domain-specific keywords (e.g., "novel," "official news") to disambiguate topics.

### 3.2 Agent: Searcher

**Type:** FastMCP Server

  * **Dual-Index Search:** Queries internal datasets ISOT (CSV) and FEVER (JSONL) via Pandas.
  * **News-Only Web Search:** Utilizes `duckduckgo_search.DDGS.news()` to exclude non-authoritative sources such as forums and blogs.
  * **Heuristic Filters:**
      * **Language:** Rejects results containing \>20% non-ASCII characters.
      * **Blocklist:** Automatically rejects unreliable domains (e.g., cheat, hack, zhihu, hinative).

### 3.3 Agent: Verifier

**Type:** FastMCP Server

  * **Pedantic Logic:** System instructions explicitly forbid "fuzzy matching" on critical data points such as Dates (Years) and Roles (e.g., President vs. Prime Minister).
  * **Structured Logging:** Appends verification records to `data/verification_logs.jsonl` for auditability.

---

## 4 Sequence of Operations

The following sequence describes the data flow from user submission to final verdict:

1.  **Submission:** User submits a **Claim** via the interface (Streamlit/Eval).
2.  **Routing (Analyzer):** Supervisor detects a missing execution plan and routes to the **Analyzer**.
3.  **Analysis:** Analyzer (Subprocess) returns a list of queries (e.g., `["Query A", "Query B"]`).
4.  **Routing (Searcher):** Supervisor detects missing evidence and routes to the **Searcher**.
5.  **Execution:** Searcher (Subprocess) executes queries:
      * Checks Local Database $\rightarrow$ **Miss**
      * Checks Web News $\rightarrow$ **Hits found** (Filtered for English language)
6.  **Routing (Verifier):** Supervisor detects valid evidence and routes to the **Verifier**.
7.  **Verification:** Verifier (Subprocess) compares **Claim** against **Evidence**.
      * *Logic Check:* Claim Year (2024) $\neq$ Evidence Year (2025).
      * *Result:* **REFUTED**.
8.  **Termination:** Supervisor identifies a final **Verdict** and terminates the workflow (**END**).